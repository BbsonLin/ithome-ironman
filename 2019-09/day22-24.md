###### tags: `第 11 屆 iT 邦鐵人賽`

# 用 Flutter 開發一個 Android App 吧 - Day 22 ~ Day 24

> 本系列同步發表在 [**個人部落格**](https://bbsonlin.github.io/tags/ironman2020/)，歡迎大家關注~
 

## Day 22.

### 首頁 - GitHub Trending

在首頁的部份除了 Day 14 看到的 Hacker News 之外，還有一個部份是要顯示 GitHub Trending (Project)。

我這邊延續 Day 14 的作法，新建 `fetchGHTrends` 方法以及修改 `buildGHTrends` 方法。

``` dart
Future fetchGHTrends() async {
  List<Project> ghTrends = await githubTrendingClient.listProjects();
  if (this.mounted) {
    setState(() {
      _ghTrends = ghTrends;
    });
  }
}
```
`fetchGHTrends` 中直接搭配前三天開發的 `githubTrendingClient` 作使用囉~


``` dart
buildGHTrends(BuildContext context) {
  if (_ghTrends == null) {
    return [
      Padding(
        padding: const EdgeInsets.all(16.0),
        child: Center(child: CircularProgressIndicator()),
      )
    ];
  } else {
    return ListTile.divideTiles(
            context: context,
            tiles: _ghTrends.sublist(0, 4).map((project) {
              return ListTile(
                title: Text("${project.fullName}"),
                subtitle: Row(
                  children: <Widget>[
                    Text("${project.language}"),
                    SizedBox(width: 16.0),
                    Text("★ ${project.stars}"),
                  ],
                ),
                onTap: () {},
              );
            }).toList())
        .toList();
  }
}
```

### GitHub 語言標籤

今天結束前的最後一節想做些小優化，想閉大家都知道 GitHub 上每個程式語言都有自己的色碼。  
而在這個專案內大量的用到它，考慮到程式複用性和維護性，所以將 GitHub 語言標籤獨立出來變成一個 Widget。

`lib/components/github_language_label.dart`
``` dart
import "package:flutter/material.dart";
import 'package:gitme_reborn/utils.dart';

class GithubLanguageLabel extends StatefulWidget {
  const GithubLanguageLabel({
    Key key,
    this.language,
    this.languageHexColor,
  }) : super(key: key);

  final String language;
  final String languageHexColor;

  @override
  _GithubLanguageLabelState createState() => _GithubLanguageLabelState();
}

class _GithubLanguageLabelState extends State<GithubLanguageLabel> {
  String _labelHexCode;

  @override
  void initState() {
    super.initState();
    searchLanguageColorHexCode(widget.language).then((labelHexCode) {
      setState(() {
        _labelHexCode = labelHexCode;
      });
    });
  }

  @override
  Widget build(BuildContext context) {
    Color labelColor;

    if (widget.languageHexColor != null) {
      labelColor = hexToColor(widget.languageHexColor);
    } else if (widget.language != null) {
      labelColor = _labelHexCode != null ? hexToColor(_labelHexCode) : Colors.black;
    }

    if (widget.language != null) {
      return Row(
        mainAxisSize: MainAxisSize.min,
        children: <Widget>[
          Text(
            "● ",
            style: TextStyle(color: labelColor, fontSize: 24.0),
          ),
          Text(widget.language),
        ],
      );
    } else {
      return SizedBox();
    }
  }
}
```

* 將之前有寫到 GitHub 語言標籤的重複部份，獨立出來，寫在 `build` 裡。
* 將 [`github-colors`](https://github.com/ozh/github-colors/blob/master/colors.json) 這個專案的 colors.json 加入到 assets 中。
* 撰寫 `searchLanguageColorHexCode` 來協助找出對應程式語言的色碼(Hex Code)。
    ``` dart
    Future<String> searchLanguageColorHexCode(String language) async {
      String githubColors =
          await rootBundle.loadString("assets/data/github-colors.json");
      var githubColorsMap = jsonDecode(githubColors);
      if (language != null) {
        return githubColorsMap[language]["color"];
      } else {
        return null;
      }
    }
    ```
* 最後將 `GithubLanguageLabel` 應用在頁面(主頁面、倉庫頁面、搜尋頁面、趨勢頁面...)

--

今日成果

![day22-1.gif](https://github.com/BbsonLin/ithome-ironman/blob/master/2019-09/images/day22-1.gif?raw=true)

---

## Day 23.


### GitHub 身份驗證

GitHub 提供的身份驗證方式有兩種:

* **基礎認證(Basic Authentication):**
    
    向 GitHub API server 發出請求時，在請求 header 中夾帶密碼即可。
    ```Authorization: Basic [YOUR PASSWORD]```
* **Token 認證(Token Authentication):**
    
    向 GitHub API server 發出請求時，在請求 header 需夾帶 token。
    ```Authorization: Token [YOUR TOKEN]```
    而 token 獲取方式需透過 Oauth2 的認證流程。


接下來會先用**基礎認證**方式作串接。


### 程式碼上的身份驗證

到目前為止，第二階段有關連接 GitHub API 方面，我都是以 token 方式作認證。

程式碼上面都是利用 `github` 這套件提供的函數作操作；今天仔細研究了一下這套件，它提供了三種認證模式:

* `Authentication.anonymous()` : 匿名模式，其實這模式沒有作任何認證；但在 GitHub 上你不做登入，還是有看到 public 的資訊的權限，不過它無法獲取登入的用戶資料，所以這裡就先不用它了。
* `Authentication.basic(this.username, this.password)` : 基礎模式，對應前一節的 **基礎認證** 。
* `Authentication.withToken(this.token)` : Token 模式，對應前一節的 **Token 認證** 。

> 小提醒:
> 
> * 雖然用 **基礎認證** 的方式進行非常容易，不過個人覺得這是較不安全的作法。
> * 使用 Oauth2 的認證方式，雖然流程比較繁瑣，但相對應得到的安全性會較高；而且 Oauth2 認證方式非常常見。
> * Oauth2 相關的架構，是需要花些時間實做跟整理的，本系列後如果有想要知道相關開發內容的大大，可以在底下留言跟我說，我會在 31 day+ 發表文章。


在 `lib/services/github_api.dart` 中 `getGithubApiClient` 函數內作相對應的調整。

![day23-1.png](https://github.com/BbsonLin/ithome-ironman/blob/master/2019-09/images/day23-1.png?raw=true)


### 登入 - 改

好了，講述的那麼多，登入畫面這邊就來實際上連接 API 囉~

![day23-2.png](https://github.com/BbsonLin/ithome-ironman/blob/master/2019-09/images/day23-2.png?raw=true)

* 宣告兩個 `TextEditingController`，方便登入時取值。
* 在兩個 `TextFormField` 加入 `controller` 屬性。
* 在 `onPressed` 裡調用 `getGithubApiClient`，並簡易的作 try catch 例外處理。

--

成果

![day23-3.gif](https://github.com/BbsonLin/ithome-ironman/blob/master/2019-09/images/day23-3.gif?raw=true)


今天就先寫到這邊，明天來收尾第二階段吧~


*參考*

* [GitHub Developer - Other Authentication Methods](https://developer.github.com/v3/auth/)

---

## Day 24.

第二階段最後一天了，來作一些小修改吧~

### 登入表單

繼昨天的增加了登入驗證後，我發現登入頁面(LoginPage)表單的程式碼有點長；
再加上我想加入表單的輸入檢查功能(validation)。  
所以我打算獨立出來一個 component `GithubLoginForm`。

`lib/components/github_login_form.dart`
``` dart
import "package:flutter/material.dart";

class GithubLoginForm extends StatefulWidget {
  const GithubLoginForm({
    Key key,
    this.onLogin,
  }) : super(key: key);

  final Function(_GithubLoginFormState state) onLogin;

  @override
  _GithubLoginFormState createState() => _GithubLoginFormState();
}

class _GithubLoginFormState extends State<GithubLoginForm> {
  bool _obscureText = true;
  FocusNode _passwordFocusNode = FocusNode();
  final formKey = GlobalKey<FormState>();
  final usernameController = TextEditingController();
  final passwordController = TextEditingController();

  @override
  Widget build(BuildContext context) {
    return Form(
      key: formKey,
      child: Padding(
        padding: const EdgeInsets.only(top: 24.0),
        child: Column(
          children: <Widget>[
            Image.asset(
              "assets/images/gitme-github-auth-trans.png",
              width: MediaQuery.of(context).size.width / 2,
            ),
            Container(
              padding: EdgeInsets.symmetric(horizontal: 24.0, vertical: 16.0),
              child: TextFormField(
                validator: (value) {
                  if (value.isEmpty) {
                    return "Please enter your GitHub username";
                  }
                  return null;
                },
                controller: usernameController,
                decoration: const InputDecoration(
                  prefixIcon: Icon(Icons.person),
                  labelText: "Name *",
                  hintText: "Your Github account username",
                ),
                onFieldSubmitted: (value) {
                  FocusScope.of(context).requestFocus(_passwordFocusNode);
                },
              ),
            ),
            Container(
              padding: EdgeInsets.symmetric(horizontal: 24.0, vertical: 16.0),
              child: TextFormField(
                focusNode: _passwordFocusNode,
                validator: (value) {
                  if (value.isEmpty) {
                    return "Please enter your GitHub password";
                  }
                  return null;
                },
                controller: passwordController,
                obscureText: _obscureText,
                decoration: InputDecoration(
                  prefixIcon: Icon(Icons.lock),
                  suffixIcon: IconButton(
                    icon: _obscureText
                        ? Icon(Icons.visibility_off)
                        : Icon(Icons.visibility),
                    onPressed: () {
                      setState(() {
                        _obscureText = !_obscureText;
                      });
                    },
                  ),
                  labelText: "Password *",
                  hintText: "Your Github account password",
                ),
              ),
            ),
            SizedBox(
              height: 52.0,
            ),
            SizedBox(
              width: MediaQuery.of(context).size.width - 48.0,
              height: 48.0,
              child: RaisedButton(
                child: Text("Login"),
                onPressed: () {
                  widget.onLogin(this);
                },
              ),
            ),
          ],
        ),
      ),
    );
  }
}
```

UI 部份原則上就是從原本的 LoginPage 複製過來，然後加上以下幾點:

* `onLogin` 屬性，這屬性設計出來讓 LoginPage 在點擊 Login 按鈕時，可以作些簡單判斷，另外函數中加入 state 參數，方便撈取值。
* 加入輸入檢查，用 `Form` 這個 Widget 搭配 `GlobalKey<FormState> formKey` 以及 `TextFormField` 的 `validator` 屬性
* 設定 `FocusNode` 用來切換不同的輸入框，參考 [Changing focus from one text field to the next in Flutter](https://stackoverflow.com/questions/49410975/changing-focus-from-one-text-field-to-the-next-in-flutter)

這樣在 LoginPage 就能簡單的在 body 裡填入 `GithubLoginForm` 來作使用，把原本 80 行的程式碼變成只有 20 行，真是通體舒暢阿~~

![day24-1.png](https://github.com/BbsonLin/ithome-ironman/blob/master/2019-09/images/day24-1.png?raw=true)

在 `GithubLoginForm.onLogin` 裡只增加 `state.formKey.currentState.validate()` 去觸發驗證，以及處理後續的判斷，這樣就大功告成拉~


### Toast 訊息

雖然 Flutter 提供的 Widget 裡有 `SnackBar` 可以當作 Alert 顯示，但我個人更喜歡用的是另一個套件 [`fluttertoast`](https://pub.dev/packages/fluttertoast)

因為他是整合 Native Code，而且更方便的是可以在任何地方打 `Fluttertoast.showToast` 就可以顯示 Toast 訊息了。

--

成果

![day24-2.gif](https://github.com/BbsonLin/ithome-ironman/blob/master/2019-09/images/day24-2.gif?raw=true)

## 小結

到今天總算第二階段完成了，不過也宣告連續30天鐵人賽發文挑戰失敗 QQ

明天進入此系列最後一階段 - 狀態管理，希望 6 天內有可補充完這部份囉~


*參考*

* [Flutter dev - Cookbook / Forms](https://flutter.dev/docs/cookbook/forms)
